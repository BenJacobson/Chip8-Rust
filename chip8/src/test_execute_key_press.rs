use super::processor::*;
use crate::logger::Logger;

use std::fs;

static RENDER_KEYS_DISPLAY_0: &str = "
XXXX............................................................
X..X............................................................
X..X............................................................
X..X............................................................
XXXX............................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
";

#[test]
fn test_execute_key_press_0() {
    let filepath = "./src/test_execute_key_press.ch8";
    let program = fs::read(filepath).expect(format!("Failed to open file: {}", filepath).as_str());

    let logger = Logger::new_null_logger();
    let mut processor = Processor::new(logger);
    processor.initialize(&program);
    processor.set_keys(0b1);
    for _ in 0..100 {
        let _ = !processor.run_next_instruction();
    }
    let display = processor.get_display();
    let expected_display: Vec<&str> = RENDER_KEYS_DISPLAY_0
        .trim()
        .split_ascii_whitespace()
        .collect();

    for i in 0..expected_display.len() {
        let row = expected_display[i];
        for j in 0..row.len() {
            let pixel = row.chars().nth(j).unwrap() != '.';
            assert_eq!(pixel, display.get_pixel(i, j));
        }
    }
}

static RENDER_KEYS_DISPLAY_ALL: &str = "
XXXX...X..XXXX.XXXX.............................................
X..X..XX.....X....X.............................................
X..X...X..XXXX.XXXX.............................................
X..X...X..X.......X.............................................
XXXX..XXX.XXXX.XXXX.............................................
................................................................
X..X.XXXX.XXXX.XXXX.............................................
X..X.X....X.......X.............................................
XXXX.XXXX.XXXX...X..............................................
...X....X.X..X..X...............................................
...X.XXXX.XXXX..X...............................................
................................................................
XXXX.XXXX.XXXX.XXX..............................................
X..X.X..X.X..X.X..X.............................................
XXXX.XXXX.XXXX.XXX..............................................
X..X....X.X..X.X..X.............................................
XXXX.XXXX.X..X.XXX..............................................
................................................................
XXXX.XXX..XXXX.XXXX.............................................
X....X..X.X....X................................................
X....X..X.XXXX.XXXX.............................................
X....X..X.X....X................................................
XXXX.XXX..XXXX.X................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
";


#[test]
fn test_execute_key_press_all() {
    let filepath = "./src/test_execute_key_press.ch8";
    let program = fs::read(filepath).expect(format!("Failed to open file: {}", filepath).as_str());

    let logger = Logger::new_null_logger();
    let mut processor = Processor::new(logger);
    processor.initialize(&program);
    processor.set_keys(0b1111111111111111);
    for _ in 0..200 {
        let _ = !processor.run_next_instruction();
    }
    let display = processor.get_display();
    let expected_display: Vec<&str> = RENDER_KEYS_DISPLAY_ALL
        .trim()
        .split_ascii_whitespace()
        .collect();

    for i in 0..expected_display.len() {
        let row = expected_display[i];
        for j in 0..row.len() {
            let pixel = row.chars().nth(j).unwrap() != '.';
            assert_eq!(pixel, display.get_pixel(i, j));
        }
    }
}
